name: Terraform Security and Deployment

on:
  push:
    branches: [development]
  pull_request:
    branches: [development, main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      auto_approve:
        description: 'Auto-apply changes'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  TF_VERSION: "1.10.0"
  ENVIRONMENT: "staging"

jobs:
  pre-validations:
    name: Pre-Validations
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-environment.outputs.environment }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set environment from input
      id: set-environment
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        else
          echo "environment=${{ env.ENVIRONMENT }}" >> $GITHUB_OUTPUT
        fi

    - name: Setup Terraform for validation
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Validate Terraform files
      run: |
        find environments/ -name "*.tf" -exec dirname {} \; | sort -u | while read dir; do
          echo "ğŸ“ Validating Terraform in $dir"
          terraform -chdir="$dir" init -backend=false > /dev/null 2>&1
          terraform -chdir="$dir" validate -no-color || exit 1
        done

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [pre-validations]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Set all sensitive values as environment variables
      run: |
        echo "TF_VAR_database_password=${{ secrets.DATABASE_PASSWORD }}" >> $GITHUB_ENV
        echo "TF_VAR_rabbitmq_password=${{ secrets.RABBITMQ_PASSWORD }}" >> $GITHUB_ENV
        echo "TF_VAR_rabbitmq_username=${{ secrets.RABBITMQ_USERNAME }}" >> $GITHUB_ENV

    - name: Terraform Init
      run: |
        cd environments/${{ needs.pre-validations.outputs.environment }}
        terraform init -input=false
      env:
        TF_WORKSPACE: ${{ needs.pre-validations.outputs.environment }}

    - name: Terraform Format Check
      run: |
        cd environments/${{ needs.pre-validations.outputs.environment }}
        terraform fmt -check -recursive -diff

    - name: Terraform Validate
      run: |
        cd environments/${{ needs.pre-validations.outputs.environment }}
        terraform validate -no-color

    - name: Terraform Plan
      id: plan
      run: |
        cd environments/${{ needs.pre-validations.outputs.environment }}
        terraform plan \
          -var="project_name=luralite" \
          -var="environment=${{ needs.pre-validations.outputs.environment }}" \
          -var="aws_region=${{ env.AWS_REGION }}" \
          -var="vpc_cidr_block=10.0.0.0/16" \
          -var='public_subnet_cidrs=["10.0.1.0/24", "10.0.2.0/24"]' \
          -var='gateway_subnet_cidrs=["10.0.10.0/24", "10.0.11.0/24"]' \
          -var='private_subnet_cidrs=["10.0.101.0/24", "10.0.102.0/24", "10.0.103.0/24"]' \
          -var="ci_cd_iam_roles=[]" \
          -var="base_domain_name=luravpn.com" \
          -var="domain_name=${{ needs.pre-validations.outputs.environment }}.luravpn.com" \
          -var='subject_alternative_names=["*.${{ needs.pre-validations.outputs.environment }}.luravpn.com"]' \
          -out=tfplan \
          -no-color \
          -input=false
        
        # Create human-readable plan summary
        terraform show -no-color tfplan > plan_summary.txt
        echo "plan_created=true" >> $GITHUB_OUTPUT
        
        # Extract plan summary for PR comment
        PLAN_SUMMARY=$(terraform show -no-color tfplan | grep -E "^[[:space:]]*#|^[[:space:]]*[+-]|^Plan:" | head -50)
        echo "PLAN_SUMMARY<<EOF" >> $GITHUB_ENV
        echo "$PLAN_SUMMARY" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Upload Terraform Plan artifacts
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan-${{ github.sha }}-${{ needs.pre-validations.outputs.environment }}
        path: |
          environments/${{ needs.pre-validations.outputs.environment }}/tfplan
          environments/${{ needs.pre-validations.outputs.environment }}/plan_summary.txt
        retention-days: 7

    - name: Display Plan Summary
      if: github.event_name == 'pull_request'
      run: |
        echo "## ğŸŒ± Terraform Plan Summary for ${{ needs.pre-validations.outputs.environment }}"
        echo ""
        echo '```'
        cat environments/${{ needs.pre-validations.outputs.environment }}/plan_summary.txt | head -50
        echo '```'
        echo ""
        echo "*Plan saved as artifact: terraform-plan-${{ github.sha }}-${{ needs.pre-validations.outputs.environment }}*"

  cost-estimation:
    name: Cost Estimation
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch') && !cancelled()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan-${{ github.sha }}-${{ needs.pre-validations.outputs.environment }}
        path: environments/${{ needs.pre-validations.outputs.environment }}

    - name: Setup Infracost
      if: env.INFRACOST_API_KEY != ''
      uses: infracost/actions/setup@v2
      with:
        api-key: ${{ secrets.INFRACOST_API_KEY }}

    - name: Generate Infracost report
      if: env.INFRACOST_API_KEY != ''
      run: |
        cd environments/${{ needs.pre-validations.outputs.environment }}
        infracost breakdown --path . \
          --format json \
          --out-file infracost.json
      continue-on-error: true

    - name: Upload Infracost report
      if: env.INFRACOST_API_KEY != ''
      uses: actions/upload-artifact@v4
      with:
        name: infracost-report-${{ github.sha }}
        path: environments/${{ needs.pre-validations.outputs.environment }}/infracost.json
        retention-days: 7

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan, cost-estimation]
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.auto_approve == 'true')
    environment: 
      name: ${{ needs.pre-validations.outputs.environment }}
      url: https://console.aws.amazon.com/
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan-${{ github.sha }}-${{ needs.pre-validations.outputs.environment }}
        path: environments/${{ needs.pre-validations.outputs.environment }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Set all sensitive values as environment variables
      run: |
        echo "TF_VAR_database_password=${{ secrets.DATABASE_PASSWORD }}" >> $GITHUB_ENV
        echo "TF_VAR_rabbitmq_password=${{ secrets.RABBITMQ_PASSWORD }}" >> $GITHUB_ENV
        echo "TF_VAR_rabbitmq_username=${{ secrets.RABBITMQ_USERNAME }}" >> $GITHUB_ENV

    - name: Terraform Init
      run: |
        cd environments/${{ needs.pre-validations.outputs.environment }}
        terraform init -input=false -reconfigure
      env:
        TF_WORKSPACE: ${{ needs.pre-validations.outputs.environment }}

    - name: Terraform Apply
      id: apply
      run: |
        set -e
        start_time=$(date +%s)
        
        echo "ğŸš€ Applying Terraform plan for ${{ needs.pre-validations.outputs.environment }}..."
        cd environments/${{ needs.pre-validations.outputs.environment }}
        terraform apply -auto-approve -input=false tfplan
        
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        echo "apply_duration=$duration" >> $GITHUB_OUTPUT
        echo "apply_status=success" >> $GITHUB_OUTPUT

    - name: Get Terraform Outputs
      run: |
        cd environments/${{ needs.pre-validations.outputs.environment }}
        terraform output -json > outputs.json
        echo "ğŸ“Š Terraform outputs saved"

    - name: Upload Terraform Outputs
      uses: actions/upload-artifact@v4
      with:
        name: terraform-outputs-${{ github.sha }}-${{ needs.pre-validations.outputs.environment }}
        path: environments/${{ needs.pre-validations.outputs.environment }}/outputs.json
        retention-days: 30

    - name: Trigger Microservice Deployments
      run: |
        echo "ğŸš€ Infrastructure updated! Checking if microservices need redeployment..."
        
        # Extract outputs to determine if services changed
        if [ -f environments/${{ needs.pre-validations.outputs.environment }}/outputs.json ]; then
          echo "ğŸ“‹ Infrastructure outputs available for service discovery"
          # Add webhook triggers or service deployment logic here
        fi

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Cleanup completed
      run: |
        echo "ğŸ§¹ Cleanup completed for workflow run ${{ github.run_id }}"

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [pre-validations, terraform-plan, terraform-apply]
    if: failure() && needs.pre-validations.result != 'skipped'
    
    steps:
    - name: Display Failure Message
      run: |
        echo "âŒ Workflow failed!"
        echo "Failed jobs:"
        echo "${{ toJSON(needs) }}" | jq -r 'to_entries[] | select(.value.result == "failure") | .key'
        echo "Environment: ${{ needs.pre-validations.outputs.environment }}"
        echo "Commit: ${{ github.sha }}"
        echo "Please check the workflow run for details."